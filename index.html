<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel do Administrador - ADD</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
    :root {
        --energisa-blue: #0097CE;
        --energisa-blue-dark: #0079a6;
        --energisa-orange: #F36F21;
    }

    body {
        background: #f4f6f9;
        font-family: 'Segoe UI', sans-serif;
    }

    .topbar {
        background: var(--energisa-blue);
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 4px solid var(--energisa-orange);
    }

    .logout-btn {
        background: var(--energisa-orange);
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: bold;
        transition: 0.3s;
    }
    .logout-btn:hover {
        background: #d95f1c;
    }

    .container {
        max-width: 97%;
        margin-top: 25px;
    }

    .table-container {
        max-height: 750px;
        overflow-y: auto;
        border: 2px solid #ddd;
        border-radius: 6px;
    }

    table td, table th {
        padding: 10px;
        font-size: 0.90rem;
    }

    .filter-card {
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgb(0 0 0 / 0.15);
    }
</style>
</head>

<body>

<!-- üîµ BARRA SUPERIOR -->
<div class="topbar">
    <h4 class="m-0">Painel do Administrador - Energisa</h4>
    <div class="d-flex align-items-center gap-2">
        <a href="https://coec-epb.github.io/prestacao_dashboard/" 
           class="btn btn-light fw-bold"
           style="border-radius: 6px;">
           ‚¨ÖÔ∏è Voltar
        </a>

        <span id="userInfo" class="me-3 fw-bold"></span>

        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>
</div>

<div class="container">

    <p id="status" class="status-msg text-danger"></p>

    <!-- üîé FILTROS -->
    <div class="filter-card mb-4">

        <div class="row">
            <div class="col-md-3">
                <label class="fw-bold">Filtrar por Regional</label>
                <select id="filtroRegional" class="form-select">
                    <option value="">Todas</option>
                    <option>LESTE</option>
                    <option>CENTRO</option>
                    <option>OESTE</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="fw-bold">Filtrar por Polo</label>
                <select id="filtroPolo" class="form-select">
                    <option value="">Todos</option>
                    <option>Jo√£o Pessoa</option><option>Itabaiana</option><option>Mamanguape</option>
                    <option>Borborema</option><option>Campina Grande</option><option>Monteiro</option>
                    <option>Guarabira</option><option>Esperan√ßa</option><option>Itaporanga</option>
                    <option>Sousa</option><option>Patos</option><option>Catol√© do Rocha</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="fw-bold">Data Inicial</label>
                <input id="dataInicio" type="date" class="form-control">
            </div>

            <div class="col-md-3">
                <label class="fw-bold">Data Final</label>
                <input id="dataFim" type="date" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">Matr√≠cula</label>
              <input
                type="text"
                id="filtroMatricula"
                class="form-control"
                placeholder="Digite a matr√≠cula"
              />
            </div>
        </div>

        <div class="d-flex justify-content-end mt-3 gap-2">
            <button id="btnFiltrar" class="btn btn-primary" onclick="aplicarFiltros()">
    üîç Aplicar
        </button>
            <button class="btn btn-secondary" onclick="limparFiltros()">‚ôªÔ∏è Limpar</button>
            <button class="btn btn-success" onclick="baixarXLSX()">‚¨áÔ∏è Baixar XLSX</button>
            <button class="btn btn-danger" onclick="excluirSelecionados()">
  üóëÔ∏è Excluir selecionados
</button>
        </div>
    </div>

    <!-- üßæ TABELA -->
    <div class="table-container">
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>
                      <input type="checkbox" id="checkTodos" onclick="marcarTodos(this)">
                    </th>
                    <th>ID</th><th>Nome</th><th>Email</th><th>Regional</th><th>Polo</th>
                    <th>Matr√≠cula</th><th>Data Uso</th><th>Tipo Refei√ß√£o</th><th>Hor√°rio</th>
                    <th>Localidade</th><th>GPS</th><th>Sequ√™ncia</th><th>OS/RRSS</th>
                    <th>N¬∫ ADD</th><th>Observa√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabela"></tbody>
        </table>
    </div>
</div>

<script>
let dados = [];
let dadosFiltrados = [];

/* ================================
    üîê BLOQUEIO DE ADMIN
================================ */

const ADMINS = ["3080117", "3056107","3001621","10267","10436","9170"];
const matriculaLogin = localStorage.getItem("matricula");

if (!matriculaLogin) {
    window.location.href = "https://coec-epb.github.io/login/";
}

if (!ADMINS.includes(matriculaLogin)) {
    alert("Acesso negado!");
    window.location.href = "https://coec-epb.github.io/prestacao_de_contas/";
}

document.getElementById("userInfo").innerText =
    "Logado como: " + matriculaLogin;

/* ================================
    LOGOUT
================================ */

function logout() {
    localStorage.removeItem("matricula");
    window.location.href = "https://coec-epb.github.io/login/";
}

/* ================================
    CARREGAR DADOS
================================ */

    

document.addEventListener("DOMContentLoaded", async () => {
  const status = document.getElementById("status");
  const hoje = new Date().toISOString().slice(0, 10);

  dados = [];
  dadosFiltrados = [];

  status.className = "status-msg text-primary fw-bold";
  status.innerText = "üîÑ Carregando em partes...";

  try {
    let offset = 0;
    const limit = 500;

    while (true) {
      const resp = await fetch(
        `https://long-hall-0aaa.pedro-fillype.workers.dev/buscar-todos?dia=${hoje}&limit=${limit}&offset=${offset}`,
        { headers: { "X-MATRICULA": localStorage.getItem("matricula") } }
      );

      const payload = await resp.json();
      const items = payload.items || [];

      dados.push(...items);
      dadosFiltrados = [...dados];

      // atualiza tela ‚Äúao vivo‚Äù
      preencherTabela(dadosFiltrados);
      status.innerText = `üîÑ Carregando... j√° veio ${dados.length} registro(s)`;

      if (!payload.hasMore) break;
      offset = payload.nextOffset;
    }

    status.classList.replace("text-primary", "text-success");
    status.innerText = `‚úÖ ${dados.length} registros carregados`;

  } catch (err) {
    status.className = "status-msg text-danger fw-bold";
    status.innerText = "‚ùå Erro ao carregar dados: " + err.message;
  }
});

    
    async function limparFiltros() {
  document.getElementById("filtroRegional").value = "";
  document.getElementById("filtroPolo").value = "";
  document.getElementById("dataInicio").value = "";
  document.getElementById("dataFim").value = "";
  document.getElementById("filtroMatricula").value = "";      

  const status = document.getElementById("status");
  status.className = "status-msg text-primary fw-bold";
  status.innerText = "üîÑ Recarregando dados...";

  try {
    const hoje = new Date().toISOString().slice(0, 10);

    const resp = await fetch(
      `https://long-hall-0aaa.pedro-fillype.workers.dev/buscar-todos?dia=${hoje}`,
      {
        headers: {
          "X-MATRICULA": localStorage.getItem("matricula")
        }
      }
    );

    dados = await resp.json();
    dadosFiltrados = [...dados];

    preencherTabela(dadosFiltrados);

    status.className = "status-msg text-success fw-bold";
    status.innerText = `‚úÖ ${dados.length} registros carregados`;

  } catch (err) {
    status.className = "status-msg text-danger fw-bold";
    status.innerText = "‚ùå Erro ao recarregar dados";
  }
}
    function baixarXLSX() {
  if (!dadosFiltrados || dadosFiltrados.length === 0) {
    alert("Nenhum dado para exportar.");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(dadosFiltrados);
  const wb = XLSX.utils.book_new();

  XLSX.utils.book_append_sheet(wb, ws, "Registros Filtrados");

  XLSX.writeFile(wb, "registros_ADD_filtrados.xlsx");
}

/* ================================
    TABELA
================================ */

function preencherTabela(lista) {
  const tabela = document.getElementById("tabela");
  tabela.innerHTML = "";

  lista.forEach(item => {
    tabela.innerHTML += `
      <tr>
        <td class="text-center">
          <input type="checkbox" class="check-item" value="${item.id}">
        </td>
        <td>${item.id}</td>
        <td>${item.nome}</td>
        <td>${item.email}</td>
        <td>${item.regional}</td>
        <td>${item.polo}</td>
        <td>${item.matricula}</td>
        <td>${item.datauso}</td>
        <td>${item.tiporefeicao}</td>
        <td>${item.horario}</td>
        <td>${item.localidade}</td>
        <td>${item.gps}</td>
        <td>${item.sequencia || ""}</td>
        <td>${item.osrrss || ""}</td>
        <td>${item.numeroadd || ""}</td>
        <td>${item.observacao || ""}</td>
      </tr>
    `;
  });
}

/* ================================
    FILTROS
================================ */

async function aplicarFiltros() {
  const status = document.getElementById("status");
  const btn = document.getElementById("btnFiltrar");

  const regional = document.getElementById("filtroRegional").value.trim();
  const polo = document.getElementById("filtroPolo").value.trim();
  const dataInicio = document.getElementById("dataInicio").value;
  const dataFim = document.getElementById("dataFim").value;
  const matricula = document.getElementById("filtroMatricula").value.trim();

  status.className = "status-msg text-primary fw-bold";
  status.innerText = "üîÑ Carregando dados...";
  btn.disabled = true;
  btn.innerHTML = "‚è≥ Aguarde...";

  try {
    dados = [];
    dadosFiltrados = [];

    let offset = 0;
    const limit = 500;

    // monta querystring s√≥ com o que existe
    const buildQS = (offsetAtual) => {
      const p = new URLSearchParams();
      if (regional) p.set("regional", regional);
      if (polo) p.set("polo", polo);
      if (matricula) p.set("matricula", matricula);
      if (dataInicio) p.set("dataInicio", dataInicio);
      if (dataFim) p.set("dataFim", dataFim);
      p.set("limit", String(limit));
      p.set("offset", String(offsetAtual));
      return p.toString();
    };

    while (true) {
      const resp = await fetch(
        `https://long-hall-0aaa.pedro-fillype.workers.dev/buscar-todos?${buildQS(offset)}`,
        {
          headers: {
            "X-MATRICULA": localStorage.getItem("matricula")
          }
        }
      );

      if (!resp.ok) {
        const t = await resp.text();
        throw new Error(`HTTP ${resp.status}: ${t}`);
      }

      const payload = await resp.json();
      const items = payload.items || [];

      dados.push(...items);
      dadosFiltrados = [...dados];

      preencherTabela(dadosFiltrados);
      status.innerText = `üîÑ Carregando... ${dados.length} registro(s)`;

      if (!payload.hasMore) break;
      offset = payload.nextOffset;
    }

    status.className = "status-msg text-success fw-bold";
    status.innerText = `‚úÖ ${dados.length} registros encontrados`;

  } catch (err) {
    status.className = "status-msg text-danger fw-bold";
    status.innerText = "‚ùå Erro ao buscar dados: " + err.message;
  } finally {
    btn.disabled = false;
    btn.innerHTML = "üîç Aplicar";
  }
}

    preencherTabela(dadosFiltrados);

    // ‚úÖ SUCESSO
    status.className = "status-msg text-success fw-bold";
    status.innerText = `‚úÖ ${dadosFiltrados.length} registros encontrados`;

  } catch (err) {
    status.className = "status-msg text-danger fw-bold";
    status.innerText = "‚ùå Erro ao buscar dados: " + err.message;
  } finally {
    // üîì REATIVA BOT√ÉO
    btn.disabled = false;
    btn.innerHTML = "üîç Aplicar";
  }
}
    function marcarTodos(checkbox) {
  document.querySelectorAll(".check-item").forEach(cb => {
    cb.checked = checkbox.checked;
  });
}
    async function excluirSelecionados() {
  const selecionados = [...document.querySelectorAll(".check-item:checked")]
    .map(cb => cb.value);

  if (selecionados.length === 0) {
    alert("Selecione ao menos um registro.");
    return;
  }

  const confirmar = confirm(
    `‚ö†Ô∏è Tem certeza que deseja excluir ${selecionados.length} registro(s)?\n\nEssa a√ß√£o N√ÉO pode ser desfeita.`
  );

  if (!confirmar) return;

  try {
    const resp = await fetch(
      "https://long-hall-0aaa.pedro-fillype.workers.dev/excluir",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-MATRICULA": localStorage.getItem("matricula")
        },
        body: JSON.stringify({ ids: selecionados })
      }
    );

    if (!resp.ok) throw new Error("Erro ao excluir");

    const resultado = await resp.json();
    alert(`‚úÖ ${resultado.excluidos} registro(s) exclu√≠dos com sucesso`);

    // üî• AQUI FAZ O REFRESH
    await limparFiltros();

  } catch (err) {
    alert("‚ùå Erro ao excluir registros");
    console.error(err);
  }
}
</script>


</body>
</html>
