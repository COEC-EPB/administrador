<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Administrador - ADD</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --energisa-blue:#0097CE;
      --energisa-blue-dark:#0079a6;
      --energisa-orange:#F36F21;
    }
    body{ background:#f4f6f9; font-family:'Segoe UI',sans-serif; }
    
    .topbar{
      background:var(--energisa-blue); color:#fff; padding:15px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:4px solid var(--energisa-orange);
    }
    .logout-btn{
      background:var(--energisa-orange); border:none; color:#fff;
      padding:8px 15px; border-radius:6px; font-weight:bold; transition:.3s;
    }
    .logout-btn:hover{ background:#d95f1c; }
    
    .container{ max-width:97%; margin-top:25px; }

    /* CARD DE FILTROS */
    .filter-card{
      padding:20px; background:#fff; border-radius:10px;
      box-shadow:0 2px 5px rgb(0 0 0 / 0.15);
    }
    .filter-title{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:15px;
    }
    .filter-title h6{
      font-size:1.1rem; margin:0; font-weight:600;
    }
    .filter-sub{
      font-size:.85rem; color:#777; margin:0;
    }
    .field-label{
      font-weight:600; margin-bottom:4px;
    }
    .divider{
      border-top:1px solid #e1e1e1;
      margin:15px 0;
    }
    .help{
      font-size:.75rem; color:#777; margin-top:3px;
    }
    
    .actions-wrap{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:flex-end;
    }

    /* ROLAGEM TABELA */
    .table-container{
      max-height:750px; overflow:auto;
      border:2px solid #ddd; border-radius:6px;
      background:#fff;
    }

    table td, table th{
      padding:10px; font-size:.90rem; white-space:nowrap;
    }

    .pager{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 0;
    }

    .muted{ color:#6c757d; font-size:.9rem; }
  </style>
</head>

<body>
  <!-- üîµ BARRA SUPERIOR -->
  <div class="topbar">
    <h4 class="m-0">Painel do Administrador - Energisa</h4>
    <div class="d-flex align-items-center gap-2">
      <a href="https://coec-epb.github.io/prestacao_dashboard/"
         class="btn btn-light fw-bold" style="border-radius:6px;">
        ‚¨ÖÔ∏è Voltar
      </a>
      <span id="userInfo" class="me-3 fw-bold"></span>
      <button class="logout-btn" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="container">
    <p id="status" class="status-msg text-danger"></p>

    <!-- üî≥ CARD DE FILTROS -->
    <div class="filter-card mb-4">

      <div class="filter-title">
        <div>
          <h6>üîé Filtros</h6>
          <p class="filter-sub">Use os filtros e clique em <b>Aplicar</b>. Solicitados ficam ocultos por padr√£o.</p>
        </div>
      </div>

      <!-- LINHA 1 -->
      <div class="row g-3">
        <div class="col-lg-3 col-md-6">
          <div class="field-label">Regional</div>
          <select id="filtroRegional" class="form-select">
            <option value="">Todas</option>
            <option>LESTE</option>
            <option>CENTRO</option>
            <option>OESTE</option>
          </select>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="field-label">Polo</div>
          <select id="filtroPolo" class="form-select">
            <option value="">Todos</option>
            <option>Jo√£o Pessoa</option><option>Itabaiana</option><option>Mamanguape</option>
            <option>Borborema</option><option>Campina Grande</option><option>Monteiro</option>
            <option>Guarabira</option><option>Esperan√ßa</option><option>Itaporanga</option>
            <option>Sousa</option><option>Patos</option><option>Catol√© do Rocha</option>
          </select>
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="field-label">Data inicial</div>
          <input id="dataInicio" type="date" class="form-control">
        </div>

        <div class="col-lg-3 col-md-6">
          <div class="field-label">Data final</div>
          <input id="dataFim" type="date" class="form-control">
        </div>
      </div>

      <div class="divider"></div>

      <!-- LINHA 2 -->
      <div class="row g-3 align-items-end">

        <div class="col-lg-6 col-md-12">
          <div class="field-label">Matr√≠cula</div>
          <input type="text" id="filtroMatricula" class="form-control" placeholder="Digite a matr√≠cula" />
          <div class="help">Se vazio, o sistema ignora este filtro.</div>
        </div>

        <div class="col-lg-2 col-md-6">
          <div class="field-label">Itens por p√°gina</div>
          <select id="selectPorPagina" class="form-select">
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
          <div class="help">Afeta pagina√ß√£o e baixar tudo.</div>
        </div>

        <div class="col-lg-4 col-md-12">
          <div class="actions-wrap">

            <button id="btnFiltrar" class="btn btn-primary" onclick="aplicarFiltros()">
              üîç Aplicar
            </button>

            <button class="btn btn-outline-secondary" onclick="limparFiltros()">
              ‚ôªÔ∏è Limpar
            </button>

            <button class="btn btn-success" onclick="baixarXLSXPaginaAtual()">
              ‚¨áÔ∏è P√°gina
            </button>

            <button class="btn btn-outline-success" onclick="baixarXLSXTudoFiltrado()">
              ‚¨áÔ∏è Baixar tudo
            </button>

            <label class="toggle">
              <input class="form-check-input" type="checkbox" id="checkTodosFiltrados">
              <span class="form-check-label">Selecionar filtrados</span>
            </label>

            <label class="toggle">
              <input class="form-check-input" type="checkbox" id="mostrarSolicitados">
              <span class="form-check-label">Mostrar solicitados</span>
            </label>

            <button class="btn btn-warning" onclick="marcarFiltradosComoSolicitado()">
              ‚úÖ Marcar como solicitado
            </button>

            <button class="btn btn-danger" onclick="excluirSelecionados()">
              üóëÔ∏è Excluir
            </button>

          </div>
        </div>

      </div>
    </div>

    <!-- PAGINA√á√ÉO -->
    <div class="pager">
      <div class="left">
        <button id="btnAnterior" class="btn btn-outline-primary" onclick="paginaAnterior()">‚¨ÖÔ∏è Anterior</button>
        <button id="btnProximo" class="btn btn-outline-primary" onclick="proximaPagina()">Pr√≥ximo ‚û°Ô∏è</button>
        <span class="muted" id="infoPaginacao">P√°gina 1</span>
      </div>
      <div class="right">
        <label class="muted m-0">Ir para p√°gina:</label>
        <input id="inputIrPagina" type="number" min="1" class="form-control" style="width:110px" />
        <button class="btn btn-outline-secondary" onclick="irParaPagina()">Ir</button>
      </div>
    </div>

    <!-- TABELA -->
    <div class="table-container">
      <table class="table table-bordered table-striped table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th class="text-center">
              <input type="checkbox" id="checkTodos" onclick="marcarTodos(this)" />
            </th>
            <th>ID</th><th>Nome</th><th>Email</th><th>Regional</th><th>Polo</th>
            <th>Matr√≠cula</th><th>Data Uso</th><th>Tipo Refei√ß√£o</th><th>Hor√°rio</th>
            <th>Localidade</th><th>GPS</th><th>Sequ√™ncia</th><th>OS/RRSS</th>
            <th>N¬∫ ADD</th><th>Observa√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tabela"></tbody>
      </table>
    </div>
  </div>

  <script>

    // Selecionar/desselecionar todos os itens da P√ÅGINA ATUAL (os que est√£o filtrados no momento)
document.getElementById("checkTodosFiltrados").addEventListener("change", (e) => {
  const checked = e.target.checked;
  document.querySelectorAll(".check-item").forEach(cb => cb.checked = checked);

  // mant√©m o checkbox do cabe√ßalho da tabela sincronizado
  const checkTodos = document.getElementById("checkTodos");
  if (checkTodos) checkTodos.checked = checked;
});
    const ADMINS = ["3080117", "3056107","3001621", "10267","10436","9170","11338","3075670","9622",
      "3049298","10267","11148","3049314","9428","3089287","6156","10349","279091","9835","8263","10432","10267",
      "8981","3049298","3075549"];

    const matriculaLogin = localStorage.getItem("matricula");
    if (!matriculaLogin) window.location.href = "https://coec-epb.github.io/login/";
    if (!ADMINS.includes(matriculaLogin)) {
      alert("Acesso negado!");
      window.location.href = "https://coec-epb.github.io/prestacao_de_contas/";
    }
    document.getElementById("userInfo").innerText = "Logado como: " + matriculaLogin;

    function logout() {
      localStorage.removeItem("matricula");
      window.location.href = "https://coec-epb.github.io/login/";
    }

    const BASE_URL = "https://long-hall-0aaa.pedro-fillype.workers.dev";

    let paginaAtual = 1;
    let totalPages = 1;
    let totalItems = 0;
    let dadosFiltrados = [];

    const filtros = {
      regional: "",
      polo: "",
      matricula: "",
      dataInicio: "",
      dataFim: "",
      limit: 50,
      mostrarSolicitados: false
    };

    function setStatus(text, type="primary") {
      const status = document.getElementById("status");
      status.className = "status-msg fw-bold text-" + type;
      status.innerText = text;
    }

    function getLimit() {
      const v = Number(document.getElementById("selectPorPagina").value || 50);
      return Number.isFinite(v) ? v : 50;
    }

    function lerFiltrosDaTela() {
      filtros.regional   = document.getElementById("filtroRegional").value.trim();
      filtros.polo       = document.getElementById("filtroPolo").value.trim();
      filtros.dataInicio = document.getElementById("dataInicio").value;
      filtros.dataFim    = document.getElementById("dataFim").value;
      filtros.matricula  = document.getElementById("filtroMatricula").value.trim();
      filtros.limit      = getLimit();
      filtros.mostrarSolicitados = document.getElementById("mostrarSolicitados").checked;
    }

    function montarQS(page, semPaginacao=false) {
      const p = new URLSearchParams();
      if (filtros.regional)   p.set("regional", filtros.regional);
      if (filtros.polo)       p.set("polo", filtros.polo);
      if (filtros.matricula)  p.set("matricula", filtros.matricula);
      if (filtros.dataInicio) p.set("dataInicio", filtros.dataInicio);
      if (filtros.dataFim)    p.set("dataFim", filtros.dataFim);

      // ‚úÖ solicitado
      if (filtros.mostrarSolicitados) p.set("mostrarSolicitados", "1");

      if (!semPaginacao) {
        p.set("page", String(page));
        p.set("limit", String(filtros.limit));
      }
      return p.toString();
    }

    function atualizarUIpaginacao() {
      document.getElementById("infoPaginacao").innerText =
        `P√°gina ${paginaAtual} de ${totalPages} ‚Ä¢ ${totalItems} registro(s)`;

      document.getElementById("btnAnterior").disabled = paginaAtual <= 1;
      document.getElementById("btnProximo").disabled = paginaAtual >= totalPages;
      document.getElementById("checkTodos").checked = false;
    }

    function preencherTabela(lista) {
      const tabela = document.getElementById("tabela");
      tabela.innerHTML = "";

      lista.forEach(item => {
        tabela.innerHTML += `
          <tr>
            <td class="text-center">
              <input type="checkbox" class="check-item" value="${item.id}">
            </td>
            <td>${item.id ?? ""}</td>
            <td>${item.nome ?? ""}</td>
            <td>${item.email ?? ""}</td>
            <td>${item.regional ?? ""}</td>
            <td>${item.polo ?? ""}</td>
            <td>${item.matricula ?? ""}</td>
            <td>${item.datauso ?? ""}</td>
            <td>${item.tiporefeicao ?? ""}</td>
            <td>${item.horario ?? ""}</td>
            <td>${item.localidade ?? ""}</td>
            <td>${item.gps ?? ""}</td>
            <td>${item.sequencia ?? ""}</td>
            <td>${item.osrrss ?? ""}</td>
            <td>${item.numeroadd ?? ""}</td>
            <td>${item.observacao ?? ""}</td>
            <td>${item.solicitado ?? ""}</td>
          </tr>
        `;
      });
    }

    function marcarTodos(checkbox) {
      document.querySelectorAll(".check-item").forEach(cb => cb.checked = checkbox.checked);
    }

    async function carregarPagina(page) {
      const btnFiltrar = document.getElementById("btnFiltrar");
      btnFiltrar.disabled = true;

      try {
        setStatus("üîÑ Carregando dados...", "primary");

        const resp = await fetch(
          `${BASE_URL}/buscar-todos?${montarQS(page)}`,
          { headers: { "X-MATRICULA": localStorage.getItem("matricula") } }
        );

        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${t}`);
        }

        const payload = await resp.json();

        dadosFiltrados = payload.items || [];
        paginaAtual = Number(payload.page || page);
        totalPages = Number(payload.totalPages || 1);
        totalItems = Number(payload.totalItems || dadosFiltrados.length);

        preencherTabela(dadosFiltrados);
        atualizarUIpaginacao();

        setStatus(`‚úÖ ${dadosFiltrados.length} registro(s) carregados na p√°gina`, "success");
      } catch (err) {
        setStatus("‚ùå Erro ao carregar dados: " + err.message, "danger");
      } finally {
        btnFiltrar.disabled = false;
      }
    }

    async function aplicarFiltros() {
      const btn = document.getElementById("btnFiltrar");
      btn.disabled = true;
      btn.innerHTML = "‚è≥ Aguarde...";

      try {
        lerFiltrosDaTela();
        paginaAtual = 1;
        await carregarPagina(paginaAtual);
      } finally {
        btn.disabled = false;
        btn.innerHTML = "üîç Aplicar";
      }
    }

    async function limparFiltros() {
      document.getElementById("filtroRegional").value = "";
      document.getElementById("filtroPolo").value = "";
      document.getElementById("dataInicio").value = "";
      document.getElementById("dataFim").value = "";
      document.getElementById("filtroMatricula").value = "";
      document.getElementById("selectPorPagina").value = "50";
      document.getElementById("mostrarSolicitados").checked = false;
      document.getElementById("checkTodosFiltrados").checked = false;

      lerFiltrosDaTela();
      paginaAtual = 1;
      await carregarPagina(paginaAtual);
    }

    async function proximaPagina() {
      if (paginaAtual < totalPages) await carregarPagina(paginaAtual + 1);
    }

    async function paginaAnterior() {
      if (paginaAtual > 1) await carregarPagina(paginaAtual - 1);
    }

    async function irParaPagina() {
      const v = Number(document.getElementById("inputIrPagina").value);
      if (!Number.isFinite(v) || v < 1) return;

      const destino = Math.max(1, Math.min(totalPages, v));
      await carregarPagina(destino);
    }

    function baixarXLSXPaginaAtual() {
      if (!dadosFiltrados || dadosFiltrados.length === 0) {
        alert("Nenhum dado na p√°gina para exportar.");
        return;
      }
      const ws = XLSX.utils.json_to_sheet(dadosFiltrados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Pagina");
      XLSX.writeFile(wb, "registros_ADD_pagina_atual.xlsx");
    }

    async function baixarXLSXTudoFiltrado() {
      lerFiltrosDaTela();

      try {
        setStatus("üîÑ Preparando exporta√ß√£o (tudo filtrado)...", "primary");

        const resp1 = await fetch(
          `${BASE_URL}/buscar-todos?${montarQS(1)}`,
          { headers: { "X-MATRICULA": localStorage.getItem("matricula") } }
        );
        if (!resp1.ok) throw new Error("Falha ao iniciar exporta√ß√£o");

        const payload1 = await resp1.json();
        const tp = Number(payload1.totalPages || 1);
        const tudo = [...(payload1.items || [])];

        setStatus(`üîÑ Exportando... p√°gina 1 de ${tp} (itens: ${tudo.length})`, "primary");

        for (let page = 2; page <= tp; page++) {
          const resp = await fetch(
            `${BASE_URL}/buscar-todos?${montarQS(page)}`,
            { headers: { "X-MATRICULA": localStorage.getItem("matricula") } }
          );
          if (!resp.ok) throw new Error(`Falha ao buscar p√°gina ${page}`);
          const payload = await resp.json();
          tudo.push(...(payload.items || []));
          setStatus(`üîÑ Exportando... p√°gina ${page} de ${tp} (itens: ${tudo.length})`, "primary");
        }

        if (tudo.length === 0) {
          alert("Nenhum dado para exportar.");
          setStatus("Nenhum registro encontrado para exporta√ß√£o.", "danger");
          return;
        }

        const ws = XLSX.utils.json_to_sheet(tudo);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Tudo");
        XLSX.writeFile(wb, "registros_ADD_tudo_filtrado.xlsx");

        setStatus(`‚úÖ Exportado com sucesso (${tudo.length} registros)`, "success");
      } catch (err) {
        setStatus("‚ùå Erro ao exportar: " + err.message, "danger");
      }
    }

    async function excluirSelecionados() {
      const selecionados = [...document.querySelectorAll(".check-item:checked")]
        .map(cb => cb.value);

      if (selecionados.length === 0) {
        alert("Selecione ao menos um registro.");
        return;
      }

      const confirmar = confirm(
        `‚ö†Ô∏è Tem certeza que deseja excluir ${selecionados.length} registro(s)?\n\nEssa a√ß√£o N√ÉO pode ser desfeita.`
      );
      if (!confirmar) return;

      try {
        const resp = await fetch(`${BASE_URL}/excluir`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-MATRICULA": localStorage.getItem("matricula")
          },
          body: JSON.stringify({ ids: selecionados })
        });

        if (!resp.ok) throw new Error("Erro ao excluir");

        const resultado = await resp.json();
        alert(`‚úÖ ${resultado.excluidos} registro(s) exclu√≠dos com sucesso`);

        await carregarPagina(paginaAtual);
        if (dadosFiltrados.length === 0 && paginaAtual > 1) {
          await carregarPagina(paginaAtual - 1);
        }
      } catch (err) {
        alert("‚ùå Erro ao excluir registros");
        console.error(err);
      }
    }

    // ‚úÖ NOVO: marcar como solicitado (por IDs ou por filtro)
    async function marcarFiltradosComoSolicitado() {
      lerFiltrosDaTela();

      const marcarTudo = document.getElementById("checkTodosFiltrados").checked;

      if (marcarTudo) {
        const confirmar = confirm("Marcar TODOS os registros filtrados como SOLICITADO? (todas as p√°ginas)");
        if (!confirmar) return;

        try {
          setStatus("üîÑ Marcando todos os filtrados como solicitado...", "primary");

          const resp = await fetch(`${BASE_URL}/marcar-solicitado-filtro?${montarQS(1, true)}`, {
            method: "POST",
            headers: { "X-MATRICULA": localStorage.getItem("matricula") }
          });

          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(data?.erro || "Falha ao marcar filtrados");

          alert(`‚úÖ Atualizados: ${data.atualizados ?? 0}`);
          await carregarPagina(1);
        } catch (err) {
          alert("‚ùå Erro: " + err.message);
          setStatus("‚ùå Erro ao marcar filtrados: " + err.message, "danger");
        }
        return;
      }

      // sen√£o: marca s√≥ os selecionados da tabela
      const selecionados = [...document.querySelectorAll(".check-item:checked")]
        .map(cb => cb.value);

      if (selecionados.length === 0) {
        alert("Selecione registros na tabela OU marque 'Selecionar TODOS filtrados'.");
        return;
      }

      const confirmar = confirm(`Marcar ${selecionados.length} registro(s) como SOLICITADO?`);
      if (!confirmar) return;

      try {
        setStatus("üîÑ Marcando selecionados como solicitado...", "primary");

        const resp = await fetch(`${BASE_URL}/marcar-solicitado`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-MATRICULA": localStorage.getItem("matricula")
          },
          body: JSON.stringify({ ids: selecionados })
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data?.erro || "Falha ao marcar selecionados");

        alert(`‚úÖ Atualizados: ${data.atualizados ?? 0}`);
        await carregarPagina(paginaAtual);
      } catch (err) {
        alert("‚ùå Erro: " + err.message);
        setStatus("‚ùå Erro ao marcar selecionados: " + err.message, "danger");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      lerFiltrosDaTela();
      await carregarPagina(1);
    });

    document.getElementById("selectPorPagina").addEventListener("change", async () => {
      lerFiltrosDaTela();
      paginaAtual = 1;
      await carregarPagina(1);
    });

    // ‚úÖ quando marcar/desmarcar "mostrar solicitados", recarrega
    document.getElementById("mostrarSolicitados").addEventListener("change", async () => {
      lerFiltrosDaTela();
      paginaAtual = 1;
      await carregarPagina(1);
    });
  </script>
</body>
</html>
